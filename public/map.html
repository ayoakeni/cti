<!DOCTYPE html>
<html>
<head>
  <title>Track Object on Google Maps with Pusher</title>
  <style>
    /* Make the map container responsive */
    #map {
      height: 100vh; /* Full viewport height */
      width: 100%;   /* Full viewport width */
    }
  </style>
  <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
  <script>
    (g => {
      var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
      b = b[c] || (b[c] = {});
      var d = b.maps || (b.maps = {}), r = new Set(), e = new URLSearchParams(), u = () => h || (h = new Promise(async (f, n) => {
        await (a = m.createElement("script"));
        e.set("libraries", [...r] + "");
        for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
        e.set("callback", c + ".maps." + q);
        a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
        d[q] = f;
        a.onerror = () => h = n(Error(p + " could not load."));
        a.nonce = m.querySelector("script[nonce]")?.nonce || "";
        m.head.append(a);
      }));
      d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n));
    })({
      key: "AIzaSyDnKdXlv5lStHzJjhIoe08s0Bw4ZcQUB18",
      v: "beta",
    });
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnKdXlv5lStHzJjhIoe08s0Bw4ZcQUB18&callback=initMap&v=weekly&libraries=marker&places" defer></script>
  <script>
    var map;
    var marker;
    var intervalId;
    var animationDuration = 1000; // 1 second
    var steps = 60; // Number of steps for the animation

    // Callback function to initialize the map
    async function initMap() {
      // Fetch token and authenticate
      const token = localStorage.getItem("token");
      console.log(token);
      const { Map } = await google.maps.importLibrary("maps");
      try {
        const response = await fetch('https://cti.maypaseducation.com/api/get/location', {
          method: 'POST',
          headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({})
        });

        // Check for content type to handle the response
        const contentType = response.headers.get('Content-Type');
        if (contentType.includes('text/html')) {
          // Handle HTML response
          const htmlContent = await response.text();
          // Insert the HTML content into a specific element
          document.getElementById('map').innerHTML = htmlContent;
          console.error('Error fetching initial location: HTML response received');
          return;
        }

        // Check for successful response
        if (!response.ok) {
          console.error('Error fetching initial location:', await response.text());
          return;
        }

        const data = await response.json();
        var course = data.vehicle.last_location.course;
        const initialLat = parseFloat(data.vehicle.last_location.latitude);
        const initialLng = parseFloat(data.vehicle.last_location.longitude);
        const model = data.vehicle.model;
        const number_plate = data.vehicle.number_plate;
        var title = model + ' ' + number_plate;
        var car = {
          url: 'car.png', // Replace with your car icon image path
          scaledSize: new google.maps.Size(30, 30),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(15, 15)
        };

        if (!isFinite(initialLat) || !isFinite(initialLng)) {
          console.error(`Invalid initial lat/lng values: ${initialLat}, ${initialLng}`);
          return;
        }

        map = new Map(document.getElementById('map'), {
          center: { lat: initialLat, lng: initialLng },
          zoom: 15
        });

        marker = new google.maps.Marker({
          position: { lat: initialLat, lng: initialLng },
          map: map,
          title: title,
          icon: car,
          rotation: ((parseFloat(course) + 90) % 360),
        });
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    }

    async function updateMarker(newLat, newLng, course, title) {
      if (!marker) {
        console.error('Marker not initialized yet. Waiting for map to load...');
        return;  // Handle case where marker hasn't been created yet
      }

      if (!isFinite(newLat) || !isFinite(newLng)) {
        console.error(`Invalid lat/lng values: ${newLat}, ${newLng}`);
        return;
      }

      marker.setPosition({ lat: newLat, lng: newLng });
      map.setCenter({ lat: newLat, lng: newLng });
      marker.setTitle(title);
      map.setCenter({ lat: newLat, lng: newLng });
      await animateMarker(newLat, newLng, course); // Wait for animation to complete
    }

    async function animateMarker(toLat, toLng, course) {
      return new Promise((resolve, reject) => {
        if (!isFinite(toLat) || !isFinite(toLng)) {
          console.error(`Invalid destination lat/lng values: ${toLat}, ${toLng}`);
          reject(new Error('Invalid lat/lng values'));
          return;
        }

        if (!marker) {
          console.error('Marker is not defined');
          reject(new Error('Marker is not defined'));
          return;
        }

        const fromLat = marker.getPosition().lat();
        const fromLng = marker.getPosition().lng();
        const stepLat = (toLat - fromLat) / steps;
        const stepLng = (toLng - fromLng) / steps;
        let step = 0;

        clearInterval(intervalId);

        intervalId = setInterval(() => {
          if (step >= steps) {
            clearInterval(intervalId);
            marker.setPosition(new google.maps.LatLng(toLat, toLng));
            map.setCenter(new google.maps.LatLng(toLat, toLng));
            resolve(); // Resolve the Promise when animation finishes
            return;
          }
          step++;
          const nextLat = fromLat + stepLat * step;
          const nextLng = fromLng + stepLng * step;
          marker.setPosition(new google.maps.LatLng(nextLat, nextLng));
          map.setCenter(new google.maps.LatLng(nextLat, nextLng));
        }, animationDuration / steps);
      });
    }

    window.onload = async function () {
      const pusher = new Pusher('cf378b7d56a8a5a1b7ad', {
        cluster: 'mt1',
        logToConsole: true
      });

      const channel = pusher.subscribe('location');
      channel.bind('car-location', async function (data) {
        console.log('Received data:', data);

        var newLat = parseFloat(data.vehicle.tracker.lat);
        var newLng = parseFloat(data.vehicle.tracker.lon);
        var course = data.vehicle.tracker.course;
        var title = data.vehicle.model;

        await updateMarker(newLat, newLng, course, title); // Wait for animation to complete
      });

      // Ensure map initialization happens before subscribing to pusher events
      await initMap();
    };
  </script>
</head>
<body>
  <div id="map"></div>
</body>
</html>